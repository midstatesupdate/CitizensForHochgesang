name: Auto-Ready Agent PRs

# Runs every 5 minutes. Finds draft PRs opened by copilot[bot] with
# no new commits in the last 5 minutes (i.e. the agent has stopped
# pushing) and marks them ready for review. This avoids triggering
# checks while the agent is still working.
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch: {} # Allow manual trigger for testing

permissions:
  pull-requests: write

jobs:
  auto-ready:
    name: Mark idle agent drafts ready
    runs-on: ubuntu-latest
    steps:
      - name: Find and promote idle agent draft PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          IDLE_MINUTES=5

          echo "üîç Checking for draft PRs by copilot[bot] idle for ${IDLE_MINUTES}+ minutes..."

          # List open draft PRs authored by copilot[bot]
          DRAFT_PRS=$(gh pr list \
            --repo "$REPO" \
            --author "app/copilot" \
            --draft \
            --state open \
            --json number,headRefName,updatedAt \
            --jq '.[]')

          if [ -z "$DRAFT_PRS" ]; then
            echo "‚ÑπÔ∏è  No draft agent PRs found."
            exit 0
          fi

          # Process each draft PR
          gh pr list \
            --repo "$REPO" \
            --author "app/copilot" \
            --draft \
            --state open \
            --json number,updatedAt \
            --jq '.[] | "\(.number) \(.updatedAt)"' | \
          while read -r PR_NUMBER UPDATED_AT; do
            # Get the timestamp of the last commit on the PR branch
            LAST_PUSH=$(gh pr view "$PR_NUMBER" \
              --repo "$REPO" \
              --json commits \
              --jq '.commits[-1].committedDate')

            # Calculate minutes since last commit
            LAST_PUSH_EPOCH=$(date -d "$LAST_PUSH" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$LAST_PUSH" +%s 2>/dev/null)
            NOW_EPOCH=$(date +%s)
            DIFF_MINUTES=$(( (NOW_EPOCH - LAST_PUSH_EPOCH) / 60 ))

            echo "  PR #$PR_NUMBER: last commit ${DIFF_MINUTES}m ago"

            if [ "$DIFF_MINUTES" -ge "$IDLE_MINUTES" ]; then
              gh pr ready "$PR_NUMBER" --repo "$REPO"
              echo "  ‚úÖ Marked PR #$PR_NUMBER as ready for review"
            else
              echo "  ‚è≥ PR #$PR_NUMBER still active ‚Äî skipping"
            fi
          done
