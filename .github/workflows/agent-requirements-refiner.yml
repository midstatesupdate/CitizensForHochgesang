name: Requirements Refiner

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  refine:
    name: Refine Requirements
    if: github.event.label.name == 'agent:refine'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for prompt access)
        uses: actions/checkout@v4

      - name: Dispatch requirements planner with fallback order
        uses: actions/github-script@v7
        env:
          PROMPT_PATH: .github/agent-prompts/requirements-agent.md
          AGENT_WAIT_MINUTES: '10'
          AGENT_POLL_SECONDS: '30'
        with:
          script: |
            const fs = require('fs')
            const owner = context.repo.owner
            const repo = context.repo.repo
            const issue_number = context.payload.issue.number
            const promptPath = process.env.PROMPT_PATH
            const promptText = fs.readFileSync(promptPath, 'utf8').trim()
            const waitMs = Number(process.env.AGENT_WAIT_MINUTES || '10') * 60 * 1000
            const pollMs = Number(process.env.AGENT_POLL_SECONDS || '30') * 1000
            const runId = process.env.GITHUB_RUN_ID
            const agents = [
              { key: 'claude', handle: '@claude' },
              { key: 'codex', handle: '@codex' },
              { key: 'copilot', handle: '@copilot' },
            ]

            const listComments = async () => {
              return github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number,
                per_page: 100,
              })
            }

            const hasStructuredPlan = (body) => {
              if (typeof body !== 'string') return false
              const text = body.toLowerCase()
              return text.includes('affected files') && text.includes('implementation steps') && text.includes('test plan')
            }

            const waitForPlan = async (dispatchCommentId) => {
              const deadline = Date.now() + waitMs
              while (Date.now() < deadline) {
                const comments = await listComments()
                const found = comments.some((comment) => {
                  if (comment.id <= dispatchCommentId) return false
                  if (comment.user?.login === 'github-actions[bot]') return false
                  return hasStructuredPlan(comment.body)
                })

                if (found) return true
                await new Promise((resolve) => setTimeout(resolve, pollMs))
              }
              return false
            }

            for (const agent of agents) {
              const marker = `<!-- agent-refine-dispatch:${agent.key}:run-${runId} -->`
              const body = [
                marker,
                `üîç **Requirements refinement dispatch started (${agent.handle}).**`,
                '',
                `${agent.handle} Please act as the requirements refinement agent for this issue and post a complete implementation plan as an issue comment.`,
                '',
                'Use the exact instructions from `.github/agent-prompts/requirements-agent.md` below, then apply them to this issue:',
                '',
                '---',
                promptText,
                '---',
              ].join('\n')

              const dispatch = await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              })

              core.info(`Posted ${agent.handle} refinement dispatch comment.`)
              const answered = await waitForPlan(dispatch.data.id)
              if (answered) {
                core.info(`Structured plan detected after ${agent.handle} dispatch.`)
                return
              }

              core.warning(`No structured plan detected from ${agent.handle} within timeout window.`)
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: [
                `<!-- agent-refine-timeout:run-${runId} -->`,
                '‚ö†Ô∏è **Requirements refinement automation timed out.**',
                '',
                'Tried in order: `@claude` ‚Üí `@codex` ‚Üí `@copilot`.',
                'No structured plan comment was detected within the configured wait windows.',
                'You can re-apply the `agent:refine` label to retry.',
              ].join('\n'),
            })
